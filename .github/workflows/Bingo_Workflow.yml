name: Bingo_Workflow

on:
  push:
    branches:
      - githubActions_improvement

jobs:

  syntax_check_job:
    name: syntax_check_job
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Linter execution
        uses: github/super-linter@v3
        env:
          DEFAULT_BRANCH: githubActions_improvement
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LINTER_RULES_PATH: /
          JAVASCRIPT_ES_CONFIG_FILE: .eslintrc.js
          VALIDATE_JAVASCRIPT_ES: true
    outputs:
      StatusJob: ${{ job.status }}

  test_execution_job:
    name: test_execution_job
    runs-on: ubuntu-latest
    needs: syntax_check_job
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Run jest tests
      run: |
        npm install
        npm install jest
        npm test
    outputs:
      StatusJob: ${{ job.status }}

  build_statics_job:
    name: build_statics_job
    runs-on: ubuntu-latest
    needs: [test_execution_job, syntax_check_job]
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: build
        run: |
          npm install
          npm run buildDev
      - name: artifact
        uses: actions/upload-artifact@v2
        with:
          name: dist
          path: ./dist
    outputs:
      StatusJob: ${{ job.status }} 

  deploy_job:
    name: deploy_job
    runs-on: ubuntu-latest
    needs: build_statics_job
    steps:
      - name: Download
        uses: actions/download-artifact@v2
        with: 
          name: dist
      - name: To deploy
        uses: dswistowski/surge-sh-action@v1
        with: 
          domain: viceentcb_bingo.surge.sh
          project: .
          login: ${{secrets.SURGELOGIN }}
          token: ${{secrets.SURGETOKEN }}
    outputs:
      StatusJob: ${{ job.status }}
  
  notification_job:
    name: notification_job
    runs-on: ubuntu-latest
    needs: [test_execution_job, syntax_check_job, build_statics_job, deploy_job]
    if: ${{ always() }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: SendMail
        uses: ./.github/actions/actionmail
        with:
          AuthorMail: ${{ secrets.AUTHORMAIL }}
          AuthorPasswd: ${{ secrets.LOGINPASSWD }}
          RecipientMail: ${{ secrets.SURGELOGIN }}
          SyntaxCheck: ${{needs.syntax_check_job.outputs.StatusJob}}
          TestExecution: ${{needs.test_execution_job.outputs.StatusJob}}
          BuildStatics: ${{needs.build_statics_job.outputs.StatusJob}}
          Deploy: ${{needs.deploy_job.outputs.StatusJob}}

  update_readme_job:
    name: update_readme_job
    runs-on: ubuntu-latest
    needs: deploy_job
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: New Line Readme
        run: |
          sed -i '$d' README.md
          echo -e "\n Ultima versión desplegada el día: `date`" >> README.md
      - name: Push
        run: |
          git config user.name viceentcb
          git config user.email viceentcb@gmail.com
          git add .
          git commit -m "Readme actualizado"
          git push origin githubActions_improvement





      


